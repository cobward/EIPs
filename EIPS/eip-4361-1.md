---
eip: TBD
title: SIWE CapGrok Extension
description: 
author: Oliver Terbu (@awoie), Jacob Ward, Sam Gbafa, Wayne Chang (@wyc), Gregory Rocco (@obstropolos)
discussions-to: TBD
status: Draft
type: Standards Track
category: ERC
created: 2021-07-20
requires: 4361
---

## Abstract
Sign-In with Ethereum (SIWE) describes how Ethereum accounts authenticate with off-chain services (relying parties) by signing a standard message format parameterized by scope, session details, and security mechanisms (e.g., a nonce). This specification describes a mechanism on top of SIWE to give informed consent to delegate capabilities with a certain extensible scope mechanism to an authorized delegee. The way how a delegee authenticates against the target resource is out of scope of this specification and depends on the implementation of the target resource. This specification is fully-backwards compatible with EIP-4361.

## Motivation

(non-normatvive)

While SIWE focuses on authenticating the Ethereum account against the service (relying party or SIWE client) initiating the SIWE flow, there is no canonical way to interact with a third-party service (resource service) on behalf of the authenticated Ethereum account. For example, a service might want to interact with a (decentralized) protocol that is performining data storage or key management on behalf of the Ethereum account. This specification introduces a mechanism, that allows the service (or more generally a delegee) to combine authentication and authorization of such while preserving security and optimizing UX.

Note, this approach is a similar mechanism to combining OpenID Connect (SIWE auth) and OAuth2 (SIWE CapGrok). Resource service implementer's should not consider CapGroks as bearer tokens but instead require to authenticate the delegee in addition. The process of authenticating the delegee against the resource service is out of scope of this specification and can be done in various different ways.

SIWE CapGroks unlock integration of (decentralized) protocols and/or APIs for developers by reducing user friction, onchain state and increasing security by introducing informed consent and deterministic capability objects.

This specification has three different audiences:
- Web3 application developers that want to integrate CapGroks to interact with Web3 protocols and APIs.
- Web3 protocol or API developers that want to learn how to define their own CapGroks.
- Wallet implementers that want to improve the UI for capgroks.

## Terms and Definitions

(non-normative)

- CapGrok - A SIWE Message complying with this specification, i.e., containing at least one CapGrok URI in the `Resources` section and the corresponding human-readable CapGrok Statement appended to the SIWE `statement`.
- CapGrok URI - A type of URI under a certain namespace that resolves to a CapGrok Details Object.
- CapGrok Details Object - A JSON object describing the actions and optionally the resources associated with a CapGrok Capability under a certain namespace.
- Resource Service (RS) - The entity that is providing third-party services for the Ethereum account.
- SIWE Client (SC) - The entity initiating the SIWE authentication and CapGrok flow.
- Relying Party (RP) - same as SC in the context of authentication.

## Specification

(normative)

### Overview

This specification defines the following:
- CapGrok SIWE Extension
- CapGrok URI Scheme
- CapGrok Details Object Schema
- CapGrok Translation Algorithm
- CapGrok Verification
- CapGrok Namespace Registry

### CapGrok SIWE Extension

A CapGrok is a EIP-4361 message following a specific format that allows an Ethereum account to delegate a set of CapGrok Capabilities to a delegee through informed consent. Each CapGrok Capability MUST be represented by an entry in the `Resources` array of the SIWE message that MUST deterministically translate the CapGrok Capability in human-readable form to the `statement` field in the SIWE message using the CapGrok Translation Algorithm.

The following SIWE message fields are used to further define (or limit) the scope of all CapGrok Capabilities:
- The `URI` field MUST specify the delegee as a URI, e.g., `https://example.com`, `did:key:z6MkhaXgBZDvotDkL5257faiztiGiC2QtKLGpbnnEGta2doK`. It is expected that the RS authenticates the delegee before executing an action for the CapGrok Capability.
- The `Issued At` field MUST be used to specify the issuance date of the CapGrok Capabilities.
- If present, the `Expiration Time` field MUST be used as the expiration time of the capability where the RS no longer accepts processing of the associated action.
- If present, the `Not Before` field MUST be used as the time that has to expire before the RS starts accepting processing of the associated action.

The following is a non-normative example of a SIWE message with the CapGrok extension:
```
example.com wants you to sign in with your Ethereum account:
0x0000000000000000000000000000000000000000

I further authorize https://example.com to perform the following actions on my behalf: (1) example: read for any. (2) example: append for my.resource.1, my.resource.2. (3) example: append, delete for my.resource.1..

URI: https://example.com
Version: 1
Chain ID: 1
Nonce: n-0S6_WzA2Mj
Issued At: 2022-06-21T12:00:00.000Z
Resources:
- urn:capability:example:JkZWZhdWx0QWN0aW9ucyI6WyJyZWFkIl0sInRhcmdldGVkQWN0aW9ucyI6eyJteS5yZXNvdXJjZS4xIjpbImFwcGVuZCIsImRlbGV0ZSJdLCJteS5yZXNvdXJjZS4yIjpbImFwcGVuZCJdfX0
```

### CapGrok URI Scheme

A CapGrok Capability is identified by their CapGrok URI which starts with `urn:capability:` followed by the namespace discriminator, followed by `:` and the base64url-encoded payload of the CapGrok Details Object.

The following is a non-normative example of a CapGrok Capability that uses the `example` namespace:
```
urn:capability:example:JkZWZhdWx0QWN0aW9ucyI6WyJyZWFkIl0sInRhcmdldGVkQWN0aW9ucyI6eyJteS5yZXNvdXJjZS4xIjpbImFwcGVuZCIsImRlbGV0ZSJdLCJteS5yZXNvdXJjZS4yIjpbImFwcGVuZCJdfX0
```

It is expected that RS implementers define their own namespace, e.g., `urn:capability:service:`. It is RECOMMENDED that RS implementers use the registry table in this specification to register their namespace and associated i8n translation file to avoid name collisions and/or name squatting.

### CapGrok Details Object Schema

The CapGrok Details Object denotes which actions on which resources the delegee is authorized to execute on behalf of the delegee for the validity period defined in the SIWE message. A CapGrok Details Object MUST follow the following JSON Schema:

```
{
   "$schema":"http://json-schema.org/draft-04/schema#",
   "type":"object",
   "properties":{
      "defaultActions":{
         "type":"array",
         "items":{
            "type":"string"
         },
         "minItems":1
      },
      "targetedActions":{
         "type":"object",
         "patternProperties":{
            "^.*$":{
               "type":"array",
               "items":{
                  "type":"string"
               },
               "minItems":1
            }
         },
         "minProperties":1
      }
   },
   "minProperties":1,
   "additionalProperties": false
}
```

A CapGrok Details Object defines the following properties:
- `defaultActions`: (CONDITIONAL) If present, `defaultActions` MUST be a JSON array of string values with at least one entry where each value describes an action executed in the RS without tying the scope to a particular target.
- `targetedActions`: (CONDITIONAL) If present, `targetedActions` MUST be a JSON object with variable properties where each property is a JSON array of string values each describing an action executed over the target resource denoted by the property name in the RS.

The following is a non-normative example of a CapGrok Capability Object with both, `defaultActions` and `targetedActions`:
```
{
   "defaultActions":[
      "read"
   ],
   "targetedActions":{
      "my.resource.1":[
         "append",
         "delete"
      ],
      "my.resource.2":[
         "append"
      ]
   }
}
```

It is expected that RS implementers define which resources they want to expose through CapGrok Details Objects and which actions they want to allow execute on them.

### CapGrok Translation Algorithm

```
capgrok-statement = statement *(capgrok-statement-entry ".")
   ; see EIP-4361 for definition of statement
capgrok-statement-entry = capgrok-action *("," capgrok-action) "for" ( "any" / capgrok-resource )
capgrok-action = string
   ; see RFC8259 for definition of string
capgrok-resource = string
   ; see RFC8259 for definition of string
```

The following algorithm or an algorithm that produces the same output MUST be performed to generate the SIWE CapGrok statement:
- Let `numbering` be an integer starting with 1.
- Let `resources` be the array of `Resources` in the SIWE message.
- For each entry in `resources` (starting with the first entry), perform the following
  - If the entry is not a CapGrok URI, then continue with next entry.
  - Let `namespace` be the `namespace` in the CapGrok URI and let `capDetails` be the base64url-decoded JSON Object of the `b64u-cap-details` in the CapGrok URI.
  - Verify the JSON Schema of `capDetails`, and if it fails, then stop processing the current entry, and continue with the next entry.
  - Append the following
- 

- (<numbering>) namespace: <action> for any. (if default actions)
- (<numbering>) namespace: <action>, <action>, ... for any. (if default actions)
- (<numbering>) namespace: <action> for <resource>.
- (<numbering>) namespace: <action>, <action>, ... for <resource>.

I further authorize did:key:example to perform the following actions on my behalf: (1) credential: present for any. (2) credential: present for type:type1. (3) kepler: list, get, metadata for kepler:ens:example.eth://default/kv. (4) kepler: list, get, metadata, put, delete for kepler:ens:example.eth://default/kv/dapp-space, kepler:ens:example.eth://default/kv/public.

statement = translateAll(statement, resources)
statement = translate(statement, capabilityUri)

To preserve an existing SIWE `statement`, the translation algorithm MUST be appended to the `statement`. 

Note, changing the order of the entries in the `Resources` array will also change the SIWE `statement` value.

In that manner, a capability consists of a namespace, resources and targeted and/or default actions the delegee MAY execute on behalf of the Ethereum account.

The namespace is denoted by the string after `urn:capability:` in the entry of the `Resources` URI. The following is the where the last portion of the URI 

```
capability-uri := "urn:capability:" <namespace> ":" <cap-details>
namespace      := urn-namespace-string
cap-details    := base64url-encode(capability)
```

Resolving a `urn:capability` URI to the capability object requires base64url-decoding the 


A capability uses the following JSON schema:

### CapGrok Verification

TBD

### CapGrok Namespace Registry

RS implementers SHOULD provide the following information and they SHOULD keep the information up-to-date:
- namespace: (REQUIRED) Name of the namespace, e.g., `example`.
- website: (OPTIONAL) Project website, e.g., `https://example.com`.
- description: (REQUIRED) Description of the namespace.
- contact(s): (REQUIRED) email or github
- action(s): (REQUIRED) array of string values where each value contains a possible action in the RS.
- status: provisional | implemented | deprecated

List of registered namespaces in alphabetical order:
-

## Implementer's Guide

(non-normative)

### Web3 Application Implementers

TBD

### Wallet Implementers

TBD

### Protocol or API Implementers

TBD

## Implementation

- https://github.com/spruceid/capgrok

### Usage Patterns
The following flow is an example flow of how SIWE CapGrok is intended to be used:

1. The SC selects the CapGrok namespace needed to consume resources of the RS. This process is out-of-scope of this specification.
2. The SC generates the CapGrok Capability URIs and applies the CapGrok Statement Translation algorithm on the set of CapGrok Delegation Objects. The result is a SIWE `statement`. 
3. The SC uses  
2. The wallet client sends the SIWE CapGrok message to the wallet.
3. The wallet displays the SIWE message according to EIP-4361 and asks the user to sign the SIWE message.
4. The user signs the SIWE message.
5. The wallet returns the signature.
6. The service 
7. The service or the delegee consumes third-party resources on behalf of the user.
8. The third-party resource authenticates the service and authorizes 

2. The wallet client sends the SIWE capgrok  and sent to the wallet client creates the SIWE request as per EIP-4361. Addition

## Copyright Waiver
Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).
